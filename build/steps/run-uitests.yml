parameters:
  projectPath: ''
  platform: ''

steps:
- task: DownloadPipelineArtifact@2
  displayName: Download NuGet
  inputs:
    artifactName: nuget

- task: UseDotNet@2
  displayName: Install .NET SDK
  inputs:
    useGlobalJson: true

- bash: |
    VERSION=$(cd $PIPELINE_WORKSPACE; ls Xappium.Cli.*.nupkg | perl -nle 'm/Xappium\.Cli\.(.*)\.nupkg/; print $1')
    echo "Installing Xappium.Cli version $VERSION from $PIPELINE_WORKSPACE"
    dotnet tool install -g Xappium.Cli --version $VERSION --add-source $PIPELINE_WORKSPACE
    xappiumtest -uitest sample/TestApp.UITests/TestApp.UITests.csproj -app ${{ parameters.projectPath }}
  displayName: Run UI Tests

- task: PublishTestResults@2
  condition: always()
  inputs:
    testRunTitle: '${{ parameters.platform }} Test Run'
    testResultsFormat: 'XUnit'
    testResultsFiles: '$(build.sourcesdirectory)/UITest/Results/*.trx'
    failTaskOnFailedTests: true

- task: PublishPipelineArtifact@1
  displayName: Publish Screenshots
  inputs:
    artifact: ${{ parameters.platform }}-screenshots
    targetPath: $(Build.SourcesDirectory)/UITests/Screenshots

- task: PublishPipelineArtifact@1
  displayName: Publish Logs
  inputs:
    artifact: ${{ parameters.platform }}-logs
    targetPath: $(Build.SourcesDirectory)/UITests/logs