trigger:
  batch: true
  branches:
    include:
    - master

stages:
  - stage: test
    displayName: Run Tests
    jobs:
      - job: android_uitest
        displayName: 'Android UI Tests'
        pool:
          vmImage: macOS-latest
          demands:
          - MSBuild
          - Xamarin.Android
          - JDK
          - AndroidSDK
        workspace:
          clean: all
        steps:
          - task: UseDotNet@2
            displayName: Install .NET 3.1 SDK
            inputs:
              version: 3.1.406

          - task: UseDotNet@2
            displayName: Install .NET 5.0 SDK
            inputs:
              useGlobalJson: true

          - task: NuGetCommand@2
            displayName: NuGet Restore
            inputs:
              command: restore

          - bash: |
              npm install -g appium
              appium &
            displayName: 'Install & Run Appium Server'

          - bash: ./run-androidtests.sh
            displayName: 'Build & Run UI Tests'

          - task: PublishTestResults@2
            condition: always()
            inputs:
              testRunTitle: 'Android Test Run'
              testResultsFormat: 'XUnit'
              testResultsFiles: '$(build.sourcesdirectory)/UITest/Results/*.trx'
              failTaskOnFailedTests: true

          - task: PublishPipelineArtifact@1
            displayName: Publish Screenshots
            inputs:
              artifact: 'android-screenshots'
              targetPath: $(Build.SourcesDirectory)/UITests/Screenshots

      - job: ios_uitest
        displayName: 'iOS UI Tests'
        pool:
          vmImage: macOS-latest
          demands:
          - MSBuild
        workspace:
          clean: all
        steps:
          # - task: InstallAppleCertificate@2
          #   inputs:
          #     certSecureFile: iOS_Development.p12
          #     certPwd: mobiledev

          # - task: InstallAppleProvisioningProfile@1
          #   inputs:
          #     provProfileSecureFile: Wildcard_Development.mobileprovision

          - task: UseDotNet@2
            displayName: Install .NET 3.1 SDK
            inputs:
              version: 3.1.406

          - task: UseDotNet@2
            displayName: Install .NET 5.0 SDK
            inputs:
              useGlobalJson: true

          - task: NuGetCommand@2
            displayName: NuGet Restore
            inputs:
              command: restore

          - bash: |
              npm install -g appium
              appium &
            displayName: 'Install & Run Appium Server'

          - bash: ./run-iostests.sh
            displayName: 'Build & Run UI Tests'

          - task: PublishTestResults@2
            condition: always()
            inputs:
              testRunTitle: 'iOS Test Run'
              testResultsFormat: 'XUnit'
              testResultsFiles: '$(build.sourcesdirectory)/UITest/Results/*.trx'
              failTaskOnFailedTests: true

          - task: PublishPipelineArtifact@1
            displayName: Publish Screenshots
            inputs:
              artifact: 'ios-screenshots'
              targetPath: $(Build.SourcesDirectory)/UITests/Screenshots